<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .year-separator {
            grid-column: 1 / -1;
            border-top: 2px solid #ccc;
            margin: 15px 0;
            text-align: center;
            color: #888;
        }
        .file-item {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
        }
        .file-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .file-corrige {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <h1>Fichiers PDF CFC (2025.02.09)</h1>

    <h2>Électricien.ne de montage</h2>
    <div id="elm-files" class="file-grid"></div>

    <h2>Installateur.trice-électricien.ne</h2>
    <div id="iel-files" class="file-grid"></div>

    <h2>Planificateur.trice-électricien.ne</h2>
    <div id="pele-files" class="file-grid"></div>

    <h2>Télématicien.ne</h2>
    <div id="tlm-files" class="file-grid"></div>

    <script>
        async function fetchFiles() {
            const apiUrl = 'https://api.github.com/repos/qrhd1/oldcfc/contents/pdf_files';
            const response = await fetch(apiUrl);
            const files = await response.json();
            return files.filter(file => file.name.endsWith('.pdf'));
        }

        function extractYear(filename) {
            // Extraire l'année au début du nom de fichier
            const match = filename.match(/^(\d{4})_/);
            return match ? match[1] : 'Autres';
        }

        function groupFiles(files) {
            const groups = {
                'elm': {}, 'iel': {}, 'pele': {}, 'tlm': {}
            };

            files.forEach(file => {
                const name = file.name.toLowerCase();
                let category;

                if (name.includes('elm')) category = 'elm';
                else if (name.includes('iel')) category = 'iel';
                else if (name.includes('pele')) category = 'pele';
                else if (name.includes('tlm')) category = 'tlm';
                else return;

                const year = extractYear(file.name);
                if (!groups[category][year]) {
                    groups[category][year] = [];
                }
                groups[category][year].push(file);
            });

            return groups;
        }

        function createYearSeparator(year) {
            const separator = document.createElement('div');
            separator.className = 'year-separator';
            separator.textContent = year !== 'Autres' ? year : '';
            return separator;
        }

        function createFileElement(files) {
            const container = document.createElement('div');
            container.className = 'file-item';

            // Trouver le fichier "donnee"
            const donneeFile = files.find(f => f.name.toLowerCase().includes('donnee'));
            const corrigeFile = files.find(f => f.name.toLowerCase().includes('corrige'));

            if (donneeFile) {
                const donneeLink = document.createElement('a');
                donneeLink.href = donneeFile.download_url;
                donneeLink.target = '_blank';
                donneeLink.className = 'file-name';
                donneeLink.textContent = donneeFile.name.split('/').pop().replace('.pdf', '');
                container.appendChild(donneeLink);

                if (corrigeFile) {
                    const corrigeLink = document.createElement('a');
                    corrigeLink.href = corrigeFile.download_url;
                    corrigeLink.target = '_blank';
                    corrigeLink.className = 'file-corrige';
                    corrigeLink.textContent = corrigeFile.name.split('/').pop().replace('.pdf', '');
                    container.appendChild(corrigeLink);
                }
            }

            return container;
        }

        function displayGroupedFiles(groupedFiles) {
            for (const [category, years] of Object.entries(groupedFiles)) {
                const container = document.getElementById(`${category}-files`);
                
                // Trier les années par ordre décroissant
                const sortedYears = Object.keys(years).sort((a, b) => b.localeCompare(a));

                sortedYears.forEach(year => {
                    // Ajouter un séparateur d'année
                    if (year !== 'Autres') {
                        container.appendChild(createYearSeparator(year));
                    }

                    // Regrouper les fichiers par base (sans corrige/donnee)
                    const groupedByBase = years[year].reduce((acc, file) => {
                        const baseName = file.name.replace(/_corrige|_donnee/i, '');
                        if (!acc[baseName]) acc[baseName] = [];
                        acc[baseName].push(file);
                        return acc;
                    }, {});

                    // Créer les éléments pour chaque groupe
                    Object.values(groupedByBase).forEach(fileGroup => {
                        const fileElement = createFileElement(fileGroup);
                        container.appendChild(fileElement);
                    });
                });
            }
        }

        async function main() {
            const files = await fetchFiles();
            const groupedFiles = groupFiles(files);
            displayGroupedFiles(groupedFiles);
        }

        main();
    </script>
</body>
</html>
